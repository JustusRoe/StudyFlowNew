<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My Study Calendar</title>

  <!-- FullCalendar CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css"
    rel="stylesheet"
  />

  <style>
    body { font-family: Arial; margin: 40px; }
    #calendar { max-width: 900px; margin: 0 auto; }
    #filters { margin-bottom: 20px; }
  </style>
</head>
<body>

  <h1>ðŸ“š My Calendar</h1>

  <!-- Filter -->
  <div id="filters">
    <label for="courseFilter">Filter by course:</label>
    <input type="text" id="courseFilter" placeholder="e.g. Math101" />
    <button id="applyFilter">Apply Filter</button>
  </div>

  <!-- Calendar -->
  <div id="calendar"></div>

  <!-- FullCalendar JS -->
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.js"></script>
  <script>
    let calendar;

    document.addEventListener('DOMContentLoaded', () => {
      const calendarEl = document.getElementById('calendar');
      const applyFilterBtn = document.getElementById('applyFilter');

      calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },

        // Dynamic event source with course filter
        events: (fetchInfo, successCallback, failureCallback) => {
          const course = encodeURIComponent(document.getElementById('courseFilter').value || '');
          const url = `/calendar/events?start=${fetchInfo.startStr}&end=${fetchInfo.endStr}&course=${course}`;

          fetch(url)
            .then(response => response.json())
            .then(data => successCallback(data))
            .catch(error => failureCallback(error));
        },

        selectable: true,
        select: (info) => {
          const title = prompt('New event title:');
          if (title) {
            fetch('/calendar/create', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                title: title,
                startTime: info.startStr,
                endTime: info.endStr,
                color: '#3a87ad', // default color
                description: 'No description'
              })
            })
            .then(() => {
              calendar.refetchEvents();
              calendar.unselect();
            })
            .catch(console.error);
          } else {
            calendar.unselect();
          }
        },

        eventClick: (info) => {
          const title = info.event.title;
          const desc = info.event.extendedProps.description || 'No description';
          const confirmed = confirm(
            `Event: ${title}\n${desc}\n\nDelete this event?`
          );
          if (confirmed) {
            fetch(`/calendar/delete/${info.event.id}`, {
              method: 'DELETE'
            })
            .then(() => calendar.refetchEvents())
            .catch(console.error);
          }
        }
      });

      calendar.render();

      // Re-fetch events when user applies a filter
      applyFilterBtn.addEventListener('click', () => {
        calendar.refetchEvents();
      });
    });
  </script>
</body>
</html>
